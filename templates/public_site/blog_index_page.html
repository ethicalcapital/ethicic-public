{% extends "public_site/base_tailwind.html" %}
{% load wagtailcore_tags wagtailimages_tags static blog_filters %}

{% block title %}{{ display_title }} - Ethical Capital{% endblock %}

{% block meta_description %}Explore Ethical Capital's investment research, market analysis, and insights on sustainable finance and ESG investing strategies.{% endblock %}

{% block content %}
<div class="container-ec py-8">
  <!-- Hero Section -->
  <section class="card-ec mb-8" role="banner" aria-labelledby="hero-heading">
    <div class="card-content-ec text-center space-y-4">
      {% if display_title and display_title.strip and display_title.strip|lower != "hide" and display_title.strip|lower
      != "blank" %}
      <h1 id="hero-heading" class="font-mono text-4xl font-bold text-gray-900 dark:text-gray-100">
        {{ display_title }}
      </h1>
      {% endif %} {% if page.intro %}
      <div class="text-xl text-gray-600 dark:text-gray-300 max-w-4xl mx-auto">{{ page.intro|richtext }}</div>
      {% endif %}
    </div>
  </section>

  <!-- Featured Article Section -->
  {% if posts %} {% with featured_post=posts.0 %}
  <section class="bg-purple-900 bg-opacity-30 border border-purple-800 rounded-lg p-6 mb-8">
    <div class="badge-ec-primary mb-4">Featured Article</div>

    <div class="grid-2col">
      <!-- Featured Content -->
      <div class="space-y-4">
        <h2 class="font-mono text-2xl text-purple-400 font-semibold">
          <a href="{{ featured_post.url_path }}" class="hover:text-purple-300 transition-colors">
            {{ featured_post.title }}
          </a>
        </h2>

        {% if featured_post.intro %}
        <p class="text-gray-200">{{ featured_post.intro }}</p>
        {% endif %}

        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span>üìÖ {{ featured_post.publish_date|date:"F j, Y" }}</span>
          {% if featured_post.reading_time %}
          <span>‚è±Ô∏è {{ featured_post.reading_time }} min read</span>
          {% endif %}
        </div>

        <a href="{{ featured_post.url_path }}" class="btn-ec-primary inline-block">Read Article</a>
      </div>

      <!-- Featured Image -->
      {% if featured_post.featured_image %}
      <div class="order-first md:order-last">
        {% image featured_post.featured_image width-500 as featured_img %}
        <img
          src="{{ featured_img.url }}"
          alt="{{ featured_post.featured_image.title|default:featured_post.title }}"
          loading="eager"
          class="w-full rounded-lg border border-gray-600"
        />
      </div>
      {% endif %}
    </div>

    <!-- Key Statistics from Featured Article -->
    {% if featured_post.content %} {% with key_stats=featured_post.content|select_key_statistics %} {% if key_stats %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 pt-6 border-t border-purple-800">
      {% for block in key_stats|slice:":3" %}
      <div class="text-center">
        <div class="font-mono text-2xl font-bold text-purple-400">{{ block.value.value }}</div>
        <div class="text-sm text-gray-400">{{ block.value.label }}</div>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %} {% endif %}
  </section>
  {% endwith %} {% endif %}

  <!-- Recent Articles Grid -->
  {% if posts %}
  <section class="card-ec mb-8">
    <div class="card-header-ec">
      <h3 class="card-title-ec">Recent Articles</h3>
    </div>
    <div class="card-content-ec">
      <div id="articles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for post in posts|slice:"1:" %}
        <article
          class="bg-gray-800 border border-gray-600 rounded-lg overflow-hidden hover:border-purple-400 transition-colors"
        >
          <!-- Article Image -->
          {% if post.featured_image %}
          <div class="aspect-video overflow-hidden">
            {% image post.featured_image width-400 as post_img %}
            <img
              src="{{ post_img.url }}"
              alt="{{ post.featured_image.title|default:post.title }}"
              class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
            />
          </div>
          {% endif %}

          <!-- Article Content -->
          <div class="p-4 space-y-3">
            <!-- Category/Tags -->
            {% if post.tags.all %}
            <div class="flex flex-wrap gap-1">
              {% for tag in post.tags.all|slice:":2" %}
              <span class="badge-ec-secondary">{{ tag.name }}</span>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Title -->
            <h4 class="font-mono text-lg text-purple-400 font-semibold leading-tight">
              <a href="{{ post.url_path }}" class="hover:text-purple-300 transition-colors">{{ post.title }}</a>
            </h4>

            <!-- Excerpt -->
            {% if post.intro %}
            <p class="text-gray-200 text-sm line-clamp-3">{{ post.intro|truncatewords:20 }}</p>
            {% endif %}

            <!-- Meta -->
            <div class="flex items-center justify-between text-xs text-gray-400 pt-2 border-t border-gray-600">
              <span>{{ post.publish_date|date:"M j, Y" }}</span>
              {% if post.reading_time %}
              <span>{{ post.reading_time }} min read</span>
              {% endif %}
            </div>

            <!-- Read More -->
            <a href="{{ post.url_path }}" class="btn-ec-secondary text-sm w-full text-center block">Read More</a>
          </div>
        </article>
        {% endfor %}
      </div>

      <!-- HTMX Infinite Scroll Trigger -->
      {% if posts.has_next %}
      <div
        id="load-more-trigger"
        hx-get="?page={{ posts.next_page_number }}"
        hx-trigger="revealed"
        hx-target="#articles-container"
        hx-swap="beforeend"
        hx-indicator="#loading-indicator"
        class="load-more-trigger"
      >
        <!-- This div will trigger loading when it comes into view -->
      </div>
      {% endif %}

      <!-- Loading indicator for infinite scroll -->
      <div id="loading-indicator" class="loading-indicator htmx-indicator text-center py-8">
        <div class="inline-block text-2xl animate-spin text-purple-400 mb-2">‚ü≥</div>
        <p class="text-gray-400">Loading more articles...</p>
      </div>
    </div>
  </section>
  {% else %}
  <!-- No Articles State -->
  <section class="card-ec text-center">
    <div class="card-content-ec">
      <div class="text-gray-400 space-y-4">
        <div class="text-4xl">üì∞</div>
        <h3 class="font-mono text-lg text-purple-400">No Articles Yet</h3>
        <p>We're working on bringing you insightful content about ethical investing.</p>
        <a href="/contact/" class="btn-ec-primary">Get Notified</a>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Newsletter Signup CTA -->
  <section class="bg-purple-900 bg-opacity-30 border border-purple-800 rounded-lg p-6 text-center">
    <h3 class="font-mono text-xl text-purple-400 font-semibold mb-4">Stay Updated on Market Insights</h3>
    <p class="text-gray-200 mb-6 max-w-2xl mx-auto">
      Get our latest research and analysis delivered to your inbox. No spam, just thoughtful investment commentary.
    </p>

    <!-- Newsletter Form -->
    <form class="max-w-md mx-auto flex gap-3" action="/newsletter-signup/" method="post">
      {% csrf_token %}
      <input
        type="email"
        name="email"
        placeholder="your@email.com"
        class="form-input-ec flex-1"
        aria-label="Your email address for newsletter subscription"
        required
      />
      <button type="submit" class="btn-ec-primary whitespace-nowrap">Subscribe</button>
    </form>

    <p class="text-xs text-gray-400 mt-3">
      Unsubscribe anytime. Read our
      <a href="/disclosures/privacy/" class="text-purple-400 hover:text-purple-300">Privacy Policy</a>
      .
    </p>
  </section>

  <!-- Archive Navigation (hidden when HTMX infinite scroll is active) -->
  {% if posts.has_other_pages %}
  <section
    class="pagination-container flex justify-center mt-8"
    x-data="{ htmxEnabled: document.body.classList.contains('htmx-settling') || typeof htmx !== 'undefined' }"
    x-show="!htmxEnabled"
  >
    <nav class="flex items-center gap-4" aria-label="Blog pagination">
      {% if posts.has_previous %}
      <a href="?page={{ posts.previous_page_number }}" class="btn-ec-secondary">‚Üê Previous</a>
      {% endif %}

      <span class="text-gray-400 text-sm">Page {{ posts.number }} of {{ posts.paginator.num_pages }}</span>

      {% if posts.has_next %}
      <a href="?page={{ posts.next_page_number }}" class="btn-ec-secondary">Next ‚Üí</a>
      {% endif %}
    </nav>
  </section>
  {% endif %}
</div>

<style>
  /* Line clamp utility for article excerpts */
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
{% endblock %} {% block extra_js %}
<script>
  // Enhanced blog index functionality with HTMX infinite scroll
  document.addEventListener('DOMContentLoaded', function() {
      // Newsletter form enhancement
      const newsletterForm = document.querySelector('form[action="/newsletter-signup/"]');
      if (newsletterForm) {
          newsletterForm.addEventListener('submit', function(e) {
              const email = this.email.value;
              if (!email || !email.includes('@')) {
                  e.preventDefault();
                  alert('Please enter a valid email address.');
                  return;
              }
          });
      }

      // Make article cards clickable and add hover effects
      function makeArticlesClickable() {
          const articles = document.querySelectorAll('article:not([data-clickable])');
          articles.forEach(article => {
              article.setAttribute('data-clickable', 'true');

              // Make clickable
              article.addEventListener('click', function(e) {
                  // Don't trigger if clicking on a link or button
                  if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                      return;
                  }

                  const link = this.querySelector('a[href*="/blog/"]');
                  if (link) {
                      window.location.href = link.href;
                  }
              });

              // Add hover effects
              article.addEventListener('mouseenter', function() {
                  this.style.transform = 'translateY(-2px)';
                  this.style.transition = 'transform 0.2s ease';
              });

              article.addEventListener('mouseleave', function() {
                  this.style.transform = 'translateY(0)';
              });
          });
      }

      // Initialize clickable articles
      makeArticlesClickable();

      // HTMX Infinite Scroll Setup
      let hasMorePages = {{ paginator.num_pages }} > 1;

      // Hide traditional pagination since we're using infinite scroll
      const paginationContainer = document.querySelector('.pagination-container');
      if (paginationContainer && hasMorePages) {
          paginationContainer.style.display = 'none';
      }

      // MutationObserver to watch for new articles being added via HTMX
      const mutationObserver = new MutationObserver((mutations) => {
          let newArticlesAdded = false;
          mutations.forEach((mutation) => {
              if (mutation.type === 'childList') {
                  mutation.addedNodes.forEach((node) => {
                      if (node.nodeType === 1 && node.tagName === 'ARTICLE') {
                          newArticlesAdded = true;
                      }
                  });
              }
          });

          if (newArticlesAdded) {
              console.log('New articles detected via HTMX');
              makeArticlesClickable();
          }
      });

      // Start observing the articles container
      const articlesContainer = document.getElementById('articles-container');
      if (articlesContainer) {
          mutationObserver.observe(articlesContainer, {
              childList: true,
              subtree: true
          });
      }

      // Smooth scroll for internal links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
              e.preventDefault();
              const target = document.querySelector(this.getAttribute('href'));
              if (target) {
                  target.scrollIntoView({
                      behavior: 'smooth',
                      block: 'start'
                  });
              }
          });
      });
  });
</script>
{% endblock %}
