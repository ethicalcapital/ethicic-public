{% extends "public_site/base_tailwind.html" %}
{% load wagtailcore_tags static %}
{% block title %}
    {{ page.title }} -
    Ethical Capital
{% endblock %}
{% block content %}
    <div class="container-ec">
        <!-- Hero Section -->
        <section class="mb-8 rounded-xl bg-gradient-to-br from-purple-900 via-gray-900 to-purple-800 p-8 text-center"
                 role="banner"
                 aria-labelledby="hero-heading">
            <h1 id="hero-heading"
                class="mb-4 text-4xl font-bold text-white md:text-5xl">{{ page.title }}</h1>
            {% if page.intro_text %}
                <div class="mx-auto max-w-3xl text-xl text-purple-100">{{ page.intro_text|richtext }}</div>
            {% endif %}
        </section>
        <!-- Legal Content with Sidebar Layout -->
        <div class="grid grid-cols-1 items-start gap-8 lg:grid-cols-3">
            <!-- Main Content Area -->
            <main class="lg:col-span-2">
                <section class="rounded-xl border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-gray-800"
                         role="main"
                         aria-labelledby="legal-heading">
                    <div class="mb-6 border-b border-gray-200 pb-4 dark:border-gray-700">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">LEGAL DOCUMENTATION</h2>
                    </div>
                    <div class="prose prose-gray dark:prose-invert max-w-none">
                        <!-- Legal Content -->
                        <div class="legal-body" id="legal-content">{{ page.content|richtext }}</div>
                    </div>
                </section>
            </main>
            <!-- Sticky Right Sidebar -->
            <aside class="space-y-6">
                <!-- Action Buttons -->
                <div class="rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-gray-800">
                    <div class="space-y-3">
                        <a href="/contact/"
                           class="block w-full rounded-lg bg-gray-600 px-4 py-3 text-center font-semibold text-white transition-colors hover:bg-purple-600">
                            QUESTIONS?
                        </a>
                        <a href="https://reports.adviserinfo.sec.gov/reports/ADV/316032/PDF/316032.pdf"
                           class="block w-full rounded-lg border border-gray-300 px-4 py-3 text-center font-semibold text-gray-700 transition-colors hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"
                           target="_blank"
                           rel="noopener">VIEW FORM ADV</a>
                    </div>
                </div>
                <!-- Legal Document Metadata -->
                <div class="rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Document Information</h3>
                    <div class="space-y-3 text-sm">
                        {% if page.effective_date %}
                            <div>
                                <span class="mb-1 block text-xs font-medium tracking-wide text-gray-600 uppercase dark:text-gray-400">
                                    Effective Date:
                                </span>
                                <time datetime="{{ page.effective_date|date:'Y-m-d' }}"
                                      class="text-gray-900 dark:text-gray-100">
                                    {{ page.effective_date|date:"F j, Y" }}
                                </time>
                            </div>
                        {% endif %}
                        {% if page.updated_at|default:None %}
                            <div>
                                <span class="mb-1 block text-xs font-medium tracking-wide text-gray-600 uppercase dark:text-gray-400">
                                    Last Updated:
                                </span>
                                <time datetime="{{ page.updated_at|date:'Y-m-d' }}"
                                      class="text-gray-900 dark:text-gray-100">
                                    {{ page.updated_at|date:"F j, Y" }}
                                </time>
                            </div>
                        {% elif page.last_published_at %}
                            <div>
                                <span class="mb-1 block text-xs font-medium tracking-wide text-gray-600 uppercase dark:text-gray-400">
                                    Last Updated:
                                </span>
                                <time datetime="{{ page.last_published_at|date:'Y-m-d' }}"
                                      class="text-gray-900 dark:text-gray-100">
                                    {{ page.last_published_at|date:"F j, Y" }}
                                </time>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <!-- Table of Contents -->
                <div class="rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-gray-100">Table of Contents</h3>
                    <div class="toc-content text-sm" id="table-of-contents">
                        <!-- Table of contents will be generated by JavaScript -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
{% endblock %}
{% block extra_js %}
    <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Generate table of contents automatically
    generateTableOfContents();
  });

  function generateTableOfContents() {
    const tocContainer = document.getElementById("table-of-contents");
    const legalContent = document.getElementById("legal-content");

    if (!tocContainer || !legalContent) {
      return;
    }

    // Find all headings in the legal content
    const headings = legalContent.querySelectorAll("h2, h3, h4, h5, h6");

    if (headings.length === 0) {
      // Hide the TOC section if no headings found
      const tocSection = tocContainer.closest(".bg-white");
      if (tocSection) {
        tocSection.style.display = "none";
      }
      return;
    }

    // Clear existing content
    tocContainer.innerHTML = "";

    // Generate TOC items
    headings.forEach(function (heading, index) {
      // Create unique ID for heading if it doesn't have one
      if (!heading.id) {
        const headingText = heading.textContent.trim();
        const id =
          "heading-" +
          index +
          "-" +
          headingText
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/^-+|-+$/g, "");
        heading.id = id;
      }

      // Determine heading level
      const level = parseInt(heading.tagName.substring(1)); // h2 -> 2, h3 -> 3, etc.

      // Create TOC item
      const tocItem = document.createElement("div");
      tocItem.className = "mb-2";

      if (level > 2) {
        tocItem.className += " ml-" + (level - 2) * 4; // Indent nested items
      }

      const tocLink = document.createElement("a");
      tocLink.href = "#" + heading.id;
      tocLink.textContent = heading.textContent.trim();
      tocLink.className =
        "block py-1 text-gray-600 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors";
      if (level > 2) {
        tocLink.className += " text-xs";
      }

      tocLink.addEventListener("click", function (e) {
        e.preventDefault();
        scrollToHeading(heading);
      });

      tocItem.appendChild(tocLink);
      tocContainer.appendChild(tocItem);
    });
  }

  function scrollToHeading(heading) {
    // Smooth scroll to heading with offset for fixed headers
    const headerOffset = 80; // Adjust based on your header height
    const elementPosition = heading.offsetTop;
    const offsetPosition = elementPosition - headerOffset;

    window.scrollTo({
      top: offsetPosition,
      behavior: "smooth",
    });

    // Add temporary highlight to the heading
    heading.style.background = "rgba(168, 85, 247, 0.1)";
    heading.style.transition = "background 0.3s ease";

    setTimeout(function () {
      heading.style.background = "";
    }, 2000);
  }
    </script>
{% endblock %}
