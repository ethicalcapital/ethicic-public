{% extends "public_site/base.html" %}
{% load wagtailcore_tags static %}

{% block title %}{{ page.title }} - Ethical Capital{% endblock %}

{% block content %}
<div class="garden-container">
    <!-- Hero Section -->
    <section class="garden-panel hero-panel" role="banner" aria-labelledby="hero-heading">
        <div class="garden-panel__content garden-panel-content">
            <h1 id="hero-heading" class="hero-title">{{ page.title }}</h1>
            {% if page.intro_text %}
                <div class="hero-subtitle">{{ page.intro_text|richtext }}</div>
            {% endif %}
            
            <!-- Hero Action Buttons -->
            <div class="hero-actions">
                <a href="/contact/" class="garden-action secondary">QUESTIONS?</a>
                <a href="https://reports.adviserinfo.sec.gov/reports/ADV/316032/PDF/316032.pdf" class="garden-action secondary" target="_blank" rel="noopener">VIEW FORM ADV</a>
            </div>
            
            <!-- Legal Document Metadata -->
            <div class="legal-metadata">
                {% if page.effective_date %}
                    <div class="metadata-item">
                        <span class="metadata-label">Effective Date:</span>
                        <time datetime="{{ page.effective_date|date:'Y-m-d' }}">{{ page.effective_date|date:"F j, Y" }}</time>
                    </div>
                {% endif %}
                {% if page.updated_at|default:None %}
                    <div class="metadata-item">
                        <span class="metadata-label">Last Updated:</span>
                        <time datetime="{{ page.updated_at|date:'Y-m-d' }}">{{ page.updated_at|date:"F j, Y" }}</time>
                    </div>
                {% elif page.last_published_at %}
                    <div class="metadata-item">
                        <span class="metadata-label">Last Updated:</span>
                        <time datetime="{{ page.last_published_at|date:'Y-m-d' }}">{{ page.last_published_at|date:"F j, Y" }}</time>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Legal Content Section -->
    <section class="garden-panel" role="main" aria-labelledby="legal-heading">
        <div class="garden-panel__header garden-panel-header">
            <div class="panel-title">LEGAL DOCUMENTATION</div>
        </div>
        <div class="garden-panel__content garden-panel-content">
            <div class="legal-document">
                <!-- Table of Contents -->
                <div class="legal-toc">
                    <h3 class="toc-title">Table of Contents</h3>
                    <div class="toc-content" id="table-of-contents">
                        <!-- Table of contents will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- Legal Content -->
                <div class="legal-main">
                    <div class="legal-body" id="legal-content">
                        {{ page.content|richtext }}
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_css %}
<!-- Garden UI Compliant Legal Page Stylesheets - Matching Blog Structure -->
<link rel="stylesheet" href="{% static 'css/garden-blog.css' %}?v=20250621-dark-mode-badge-fix">
<link rel="stylesheet" href="{% static 'css/garden-blog-hero.css' %}?v=20250621-bottom-align-utilities">
<link rel="stylesheet" href="{% static 'css/garden-blog-articles.css' %}?v=20250621-dark-mode-badge-fix">
<link rel="stylesheet" href="{% static 'css/garden-blog-panels.css' %}?v=20250621-dark-mode-badge-fix">
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate table of contents automatically
    generateTableOfContents();
});

function generateTableOfContents() {
    const tocContainer = document.getElementById('table-of-contents');
    const legalContent = document.getElementById('legal-content');
    
    if (!tocContainer || !legalContent) {
        return;
    }
    
    // Find all headings in the legal content
    const headings = legalContent.querySelectorAll('h2, h3, h4, h5, h6');
    
    if (headings.length === 0) {
        // Hide the TOC section if no headings found
        const tocSection = document.querySelector('.legal-toc');
        if (tocSection) {
            tocSection.style.display = 'none';
        }
        return;
    }
    
    // Clear existing content
    tocContainer.innerHTML = '';
    
    // Generate TOC items
    headings.forEach(function(heading, index) {
        // Create unique ID for heading if it doesn't have one
        if (!heading.id) {
            const headingText = heading.textContent.trim();
            const id = 'heading-' + index + '-' + headingText
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            heading.id = id;
        }
        
        // Determine heading level
        const level = parseInt(heading.tagName.substring(1)); // h2 -> 2, h3 -> 3, etc.
        const cssLevel = Math.min(level, 4); // Cap at level 4 for CSS
        
        // Create TOC item
        const tocItem = document.createElement('div');
        tocItem.className = 'toc-item level-' + cssLevel;
        
        const tocLink = document.createElement('a');
        tocLink.href = '#' + heading.id;
        tocLink.textContent = heading.textContent.trim();
        tocLink.addEventListener('click', function(e) {
            e.preventDefault();
            scrollToHeading(heading);
        });
        
        tocItem.appendChild(tocLink);
        tocContainer.appendChild(tocItem);
    });
}

function scrollToHeading(heading) {
    // Smooth scroll to heading with offset for fixed headers
    const headerOffset = 80; // Adjust based on your header height
    const elementPosition = heading.offsetTop;
    const offsetPosition = elementPosition - headerOffset;

    window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
    });
    
    // Add temporary highlight to the heading
    heading.style.background = 'var(--color-primary-alpha)';
    heading.style.transition = 'background 0.3s ease';
    
    setTimeout(function() {
        heading.style.background = '';
    }, 2000);
}
</script>
{% endblock %}