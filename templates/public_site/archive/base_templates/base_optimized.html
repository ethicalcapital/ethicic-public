<!DOCTYPE html>
<html lang="en" data-theme="{{ current_theme|default:'light' }}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            {% block title %}{{ page_title|default:"Ethical Capital" }}{% endblock %}
        </title>
        {% load static wagtailsettings_tags menu_tags %}
        {% get_settings "public_site.SiteConfiguration" as site_config %}
        <!-- Critical CSS inline for FOUC prevention -->
        <style>
        /* Garden UI Critical CSS - Prevents Flash of Unstyled Content */
        :root{--garden-bg:#fff;--garden-fg:#111;--garden-accent:#3d2970;--garden-border:#e5e7eb;--garden-surface:#fff}[data-theme=dark]{--garden-bg:#121212;--garden-fg:#f0f0f0;--garden-accent:#553c9a;--garden-border:#333;--garden-surface:#1a1a1a}@media (prefers-color-scheme:dark){[data-theme=auto]{--garden-bg:#121212;--garden-fg:#f0f0f0;--garden-accent:#553c9a;--garden-border:#333;--garden-surface:#1a1a1a}}html{background-color:var(--garden-bg);color:var(--garden-fg);overflow-x:hidden}body{margin:0;padding:0;min-height:100vh;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;line-height:1.6}.garden-header{min-height:60px;background-color:var(--garden-accent);position:sticky;top:0;z-index:1000}.main-content,main{min-height:calc(100vh - 60px);contain:layout}.garden-container{max-width:1200px;margin:0 auto;padding:0 24px}.garden-mobile-menu-toggle{display:none}@media (max-width:768px){.garden-nav-main{display:none}.garden-mobile-menu-toggle{display:flex;width:44px;height:44px}}h1,h2,h3,h4,h5,h6{font-weight:600;line-height:1.2;margin-top:0}.garden-action,button{display:inline-flex;align-items:center;padding:8px 16px;border:2px solid transparent;border-radius:4px;cursor:pointer;text-decoration:none;transition:none}.garden-action.primary{background-color:var(--garden-accent);color:#fff;border-color:var(--garden-accent)}.garden-action.secondary{background-color:transparent;color:var(--garden-accent);border-color:var(--garden-border)}input,textarea,select{background-color:var(--garden-bg);color:var(--garden-fg);border:1px solid var(--garden-border);padding:8px 12px;border-radius:4px}.garden-panel{background-color:var(--garden-surface);border:1px solid var(--garden-border);border-radius:4px;overflow:hidden;margin-bottom:24px}.garden-panel-content{padding:24px}.garden-loading{position:fixed;top:0;left:0;right:0;bottom:0;background-color:var(--garden-bg);z-index:9999;display:flex;align-items:center;justify-content:center}.garden-loaded .garden-loading{display:none}.garden-header,.garden-nav-mobile{will-change:transform}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}:focus{outline:2px solid var(--garden-accent);outline-offset:2px}.skip-link:focus{position:fixed;top:10px;left:10px;z-index:10000;padding:8px 16px;background-color:var(--garden-accent);color:#fff;text-decoration:none}
        </style>
        <!-- Optimized font loading strategy -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap"
              rel="stylesheet">
        <!-- OPTIMIZED: Single CSS file from build process -->
        {% if DEBUG %}
            <link rel="stylesheet"
                  href="{% static 'css/dist/development.css' %}?v={{ BUILD_VERSION|default:'1' }}">
        {% else %}
            <link rel="stylesheet"
                  href="{% static 'css/dist/production.css' %}?v={{ BUILD_VERSION|default:'1' }}">
        {% endif %}
        <!-- Meta tags for SEO and social sharing -->
        <meta name="description"
              content="{% block meta_description %}{% if page %}{{ page.search_description|default:site_config.meta_description|default:'Ethical Capital provides socially responsible investment advisory services with a focus on sustainable and ethical investing.' }}{% else %}{{ site_config.meta_description|default:'Ethical Capital provides socially responsible investment advisory services with a focus on sustainable and ethical investing.' }}{% endif %}{% endblock %}">
        <meta name="keywords"
              content="{% block meta_keywords %}{{ site_config.meta_keywords|default:'ethical investing, sustainable investing, ESG investing, socially responsible investing, investment advisory' }}{% endblock %}">
        <!-- Open Graph tags -->
        <meta property="og:title"
              content="{% block og_title %}{% if page %}{{ page.seo_title|default:page.title|default:'Ethical Capital' }}{% else %}Ethical Capital{% endif %}{% endblock %}">
        <meta property="og:description"
              content="{% block og_description %}{% if page %}{{ page.search_description|default:site_config.meta_description }}{% else %}{{ site_config.meta_description }}{% endif %}{% endblock %}">
        <meta property="og:url"
              content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
        <meta property="og:type" content="{% block og_type %}website{% endblock %}">
        <meta property="og:image"
              content="{% block og_image %}{% static 'images/og-default.svg' %}{% endblock %}">
        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
        <!-- CSRF Token for JavaScript -->
        {% csrf_token %}
        <meta name="csrf-token" content="{{ csrf_token }}">
        <!-- HTMX for server-driven interactivity -->
        <script src="https://unpkg.com/htmx.org@1.9.11"></script>
        <!-- Alpine.js for lightweight client-side reactivity -->
        <script defer src="https://unpkg.com/alpinejs@3.13.7/dist/cdn.min.js"></script>
        <!-- PostHog snippet -->
        <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('{{ POSTHOG_API_KEY }}',{api_host:'https://us.i.posthog.com'})
        </script>
        <!-- WCAG AA Accessibility Enhancements for HTMX -->
        <script src="{% static 'js/accessibility-htmx.js' %}?v=1"></script>
        <!-- WCAG AA Focus Trapping for Modals and Overlays -->
        <script src="{% static 'js/accessibility-focus-trap.js' %}?v=1"></script>
        {% block extra_css %}{% endblock %}
        <!-- Temporary inline styles to force new color scheme -->
        <style>
        /* Lavender Blush background for light mode */
        [data-theme="light"] body,
        [data-theme="light"] .main-content,
        [data-theme="light"] .garden-panel {
            background-color: #FCEFEF !important;
        }

        /* Lavender primary color for headers and accents */
        [data-theme="light"] .garden-header,
        [data-theme="light"] .garden-panel__header,
        [data-theme="light"] .garden-panel-header {
            background-color: #B57EDC !important;
        }

        /* Tiffany Blue CTAs in light mode - comprehensive selectors */
        [data-theme="light"] .garden-action.primary,
        [data-theme="light"] .garden-nav-actions .garden-action.primary,
        [data-theme="light"] .garden-header .garden-action.primary,
        [data-theme="light"] .hero-panel .cta-actions .garden-action.primary,
        [data-theme="light"] .cta-panel .garden-action.primary,
        [data-theme="light"] .serve-item .garden-action.primary,
        [data-theme="light"] a.garden-action.primary,
        [data-theme="light"] button.garden-action.primary,
        html[data-theme="light"] .garden-action.primary {
            background-color: #7bcdba !important;
            color: #111 !important;
            border: 2px solid #7bcdba !important;
            text-decoration: none !important;
        }

        [data-theme="light"] .garden-action.primary:hover,
        [data-theme="light"] a.garden-action.primary:hover,
        [data-theme="light"] button.garden-action.primary:hover,
        html[data-theme="light"] .garden-action.primary:hover {
            background-color: #6ab8a5 !important;
            border-color: #6ab8a5 !important;
            color: #111 !important;
        }

        /* Dark purple for dark mode */
        [data-theme="dark"] .garden-header,
        :root .garden-header {
            background-color: #1f0322 !important;
        }

        /* Maya Blue CTAs in dark mode */
        [data-theme="dark"] .garden-action.primary,
        :root .garden-action.primary {
            background-color: #55c1ff !important;
            color: #000 !important;
            border: 2px solid #55c1ff !important;
        }

        [data-theme="dark"] .garden-action.primary:hover,
        :root .garden-action.primary:hover {
            background-color: #3fb4ff !important;
            border-color: #3fb4ff !important;
        }

        /* Ensure text is readable */
        [data-theme="light"] body {
            color: #111 !important;
        }

        /* Force ALL primary buttons to be Tiffany Blue in light mode */
        html[data-theme="light"] body .garden-action.primary {
            background-color: #7bcdba !important;
            background-image: none !important;
            color: #111 !important;
            border: 2px solid #7bcdba !important;
        }

        /* Debug: Make sure we catch the header Get Started button */
        html[data-theme="light"] body .garden-header .garden-nav-actions a.primary {
            background-color: #7bcdba !important;
            color: #111 !important;
        }

        /* Hero section buttons - target both primary and ensure specificity */
        html[data-theme="light"] body .hero-panel .cta-actions a.garden-action.primary,
        html[data-theme="light"] body .cta-actions .garden-action.primary {
            background-color: #7bcdba !important;
            color: #111 !important;
            border-color: #7bcdba !important;
        }

        /* Target any link with garden-action primary classes */
        html[data-theme="light"] body a.garden-action.primary {
            background-color: #7bcdba !important;
            background-image: none !important;
            color: #111 !important;
            border: 2px solid #7bcdba !important;
        }
        </style>
    </head>
    <body class="public-site-context garden-loaded {% block body_class %}{% endblock %}">
        <!-- Skip navigation links for screen readers -->
        <a href="#main-content" class="skip-link">Skip to main content</a>
        <a href="#main-navigation" class="skip-link">Skip to navigation</a>
        <!-- ARIA live regions for announcements -->
        <div aria-live="polite"
             aria-atomic="true"
             class="sr-announcements"
             id="announcements"></div>
        <div aria-live="assertive"
             aria-atomic="true"
             class="sr-only"
             id="urgent-announcements"></div>
        <!-- Clean Navigation Header -->
        <header class="garden-header"
                role="banner"
                x-data="{ mobileMenuOpen: false }">
            <div class="garden-header-content">
                <div class="garden-nav-left">
                    <a href="/" class="garden-brand" aria-label="Ethical Capital Home">
                        {{ site_config.company_name|default:"ETHICAL CAPITAL" }}
                    </a>
                    <!-- Mobile menu toggle - Updated to use new Garden UI mobile nav -->
                    <button class="garden-hamburger garden-mobile-menu-toggle"
                            @click="mobileMenuOpen = !mobileMenuOpen"
                            :class="{ 'active': mobileMenuOpen }"
                            aria-label="Toggle navigation menu"
                            aria-expanded="false"
                            :aria-expanded="mobileMenuOpen.toString()">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                    <!-- Desktop navigation -->
                    <nav class="garden-nav garden-nav-main desktop-nav" id="main-navigation">
                        {% main_menu max_levels=1 template="wagtailmenus/main_menu.html" %}
                    </nav>
                </div>
                <div class="garden-nav-right">
                    <!-- Search - visibility based on user authentication -->
                    {% if user.is_authenticated %}
                        <div class="search-container" id="search-container">{% include "public_site/partials/search_widget.html" %}</div>
                    {% endif %}
                    <!-- Control buttons -->
                    <div class="control-buttons">
                        <!-- Theme toggle always visible -->
                        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
                            <span class="theme-icon">🌙</span>
                        </button>
                        <!-- User menu dropdown -->
                        {% if user.is_authenticated %}
                            <div class="user-menu-container" x-data="{ open: false }">
                                <button @click="open = !open"
                                        @click.away="open = false"
                                        class="user-menu-button"
                                        aria-label="User menu"
                                        :aria-expanded="open.toString()">
                                    <svg class="user-icon"
                                         viewBox="0 0 20 20"
                                         fill="currentColor"
                                         width="20"
                                         height="20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <div x-show="open" x-transition class="dropdown-menu" role="menu">
                                    <a href="{% url 'user-profile' %}" class="dropdown-item" role="menuitem">Profile</a>
                                    <div class="dropdown-divider"></div>
                                    <form method="post" action="{% url 'account_logout' %}" class="mb-0">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item text-danger" role="menuitem">Sign Out</button>
                                    </form>
                                </div>
                            </div>
                        {% else %}
                            <a href="{% url 'account_login' %}"
                               class="garden-action secondary login-button">Sign In</a>
                        {% endif %}
                    </div>
                    <!-- Call to action button (hidden on mobile) -->
                    <div class="garden-nav-actions desktop-only">
                        <a href="/onboarding/start/" class="garden-action primary">Get Started</a>
                    </div>
                </div>
            </div>
            <!-- Mobile Navigation Menu - Using new Garden UI mobile nav -->
            <nav class="garden-nav-mobile"
                 :class="{ 'active': mobileMenuOpen }"
                 x-show="mobileMenuOpen"
                 x-transition>
                {% main_menu max_levels=1 template="wagtailmenus/mobile_menu.html" %}
                <!-- Mobile search -->
                {% if user.is_authenticated %}
                    <div class="garden-search mobile-search">{% include "public_site/partials/search_widget.html" %}</div>
                {% endif %}
                <!-- Mobile user actions -->
                <div class="garden-user-actions">
                    {% if user.is_authenticated %}
                        <a href="{% url 'user-profile' %}" class="garden-nav-item">Profile</a>
                        <form method="post" action="{% url 'account_logout' %}" class="mb-0">
                            {% csrf_token %}
                            <button type="submit" class="garden-nav-item text-danger">Sign Out</button>
                        </form>
                    {% else %}
                        <a href="{% url 'account_login' %}" class="garden-nav-item">Sign In</a>
                        <a href="/onboarding/start/" class="garden-action primary full-width">Get Started</a>
                    {% endif %}
                </div>
            </nav>
            <!-- Mobile nav overlay -->
            <div class="garden-nav-overlay"
                 :class="{ 'active': mobileMenuOpen }"
                 x-show="mobileMenuOpen"
                 @click="mobileMenuOpen = false"></div>
        </header>
        <!-- Main content area -->
        <main class="main-content" id="main-content">
            {% block content %}{% endblock %}
        </main>
        <!-- Footer -->
        {% include "public_site/partials/footer.html" %}
        <!-- Theme toggle script with proper initialization -->
        <script>
        // Pass server-side theme to client
        window.gardenInitialTheme = "{{ current_theme|default:'auto' }}";
        </script>
        <script src="{% static 'js/garden-theme-toggle.js' %}?v=4"></script>
        <!-- Initialize Alpine.js components -->
        <script>
        document.addEventListener('alpine:init', () => {
            // Any Alpine.js component initialization
        });
        </script>
        {% block extra_js %}{% endblock %}
    </body>
</html>
