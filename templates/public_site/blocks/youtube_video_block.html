{% load wagtailcore_tags %}

<!-- Enhanced YouTube Video Embed Block -->
<div class="youtube-video-block-container" role="region" aria-label="YouTube video content">
  {% if value.youtube_url %}
    <div class="responsive-video-wrapper">
      <!-- Responsive video container with 16:9 aspect ratio -->
      <div class="aspect-video w-full bg-slate-900 rounded-lg overflow-hidden shadow-lg border border-slate-600 relative">
        <div class="video-embed h-full w-full" data-youtube-url="{{ value.youtube_url }}">
          <iframe
            class="w-full h-full rounded-lg"
            src="{% youtube_embed_url value.youtube_url value.start_time value.autoplay %}"
            title="{% if value.title %}{{ value.title }}{% else %}YouTube video{% endif %}"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            loading="lazy"
            referrerpolicy="strict-origin-when-cross-origin"
            aria-label="{% if value.title %}{{ value.title }}{% else %}YouTube video{% endif %}"
          ></iframe>
        </div>
        
        <!-- Loading overlay -->
        <div class="video-loading-overlay absolute inset-0 bg-slate-900 flex items-center justify-center transition-opacity duration-300">
          <div class="text-center space-y-3 text-slate-300">
            <svg class="w-8 h-8 mx-auto animate-spin text-slate-500" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div class="text-sm">Loading video...</div>
          </div>
        </div>
      </div>
      
      {% if value.title %}
        <!-- Video caption/title -->
        <div class="mt-3 text-center">
          <p class="text-sm text-slate-300 font-medium">{{ value.title }}</p>
        </div>
      {% endif %}
      
      <!-- Video metadata for accessibility -->
      <div class="sr-only" aria-hidden="true">
        Video hosted on YouTube. 
        {% if value.start_time %}Starts at {{ value.start_time }} seconds. {% endif %}
        {% if value.autoplay %}Autoplay enabled. {% endif %}
      </div>
    </div>
  {% else %}
    <!-- Fallback for empty YouTube video block -->
    <div class="youtube-video-placeholder aspect-video w-full bg-slate-800 rounded-lg overflow-hidden shadow-lg border border-slate-600 flex items-center justify-center">
      <div class="text-center space-y-3 text-slate-300">
        <svg class="w-16 h-16 mx-auto text-red-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
        </svg>
        <div class="text-lg font-medium">No YouTube Video Selected</div>
        <div class="text-sm text-slate-400">Add a YouTube URL in the editor</div>
      </div>
    </div>
  {% endif %}
</div>

<style>
/* Enhanced YouTube video block styling */
.youtube-video-block-container {
  margin: 2rem 0;
  max-width: 100%;
}

/* Ensure proper iframe loading and display */
.video-embed iframe {
  transition: opacity 0.3s ease-in-out;
  background-color: #0f172a; /* slate-900 */
}

/* Hide loading overlay once iframe loads */
.video-embed iframe:loaded + .video-loading-overlay {
  opacity: 0;
  pointer-events: none;
}

/* YouTube red play button styling for placeholder */
.youtube-video-placeholder svg {
  filter: drop-shadow(0 4px 6px rgb(0 0 0 / 0.1));
}

/* Responsive enhancements for mobile */
@media (max-width: 640px) {
  .youtube-video-block-container {
    margin: 1.5rem 0;
  }
  
  .aspect-video {
    border-radius: 0.5rem;
  }
}

/* Enhanced focus styles for accessibility */
.video-embed iframe:focus {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

/* Dark mode adjustments */
@media (prefers-color-scheme: dark) {
  .youtube-video-placeholder,
  .responsive-video-wrapper .aspect-video {
    background-color: rgb(15 23 42); /* slate-900 */
    border-color: rgb(71 85 105); /* slate-600 */
  }
}

/* Reduce motion for accessibility */
@media (prefers-reduced-motion: reduce) {
  .video-embed iframe,
  .video-loading-overlay {
    transition: none;
  }
  
  .video-loading-overlay svg {
    animation: none;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Handle YouTube video loading states
  const videoEmbeds = document.querySelectorAll('.video-embed iframe');
  
  videoEmbeds.forEach(function(iframe) {
    iframe.addEventListener('load', function() {
      const loadingOverlay = this.parentNode.querySelector('.video-loading-overlay');
      if (loadingOverlay) {
        setTimeout(() => {
          loadingOverlay.style.opacity = '0';
          loadingOverlay.style.pointerEvents = 'none';
        }, 500);
      }
    });
    
    // Error handling
    iframe.addEventListener('error', function() {
      const container = this.closest('.youtube-video-block-container');
      if (container) {
        container.innerHTML = `
          <div class="aspect-video w-full bg-red-900/20 rounded-lg overflow-hidden shadow-lg border border-red-600 flex items-center justify-center">
            <div class="text-center space-y-3 text-red-300">
              <svg class="w-16 h-16 mx-auto text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div class="text-lg font-medium">Video Load Error</div>
              <div class="text-sm text-red-400">Unable to load YouTube video</div>
            </div>
          </div>
        `;
      }
    });
  });
});
</script>