{% extends "public_site/base_tailwind.html" %}

{% block title %}Contact Ethical Capital{% endblock %}

{% block content %}
<div class="container-ec">
  <!-- Page Header -->
  <div class="text-center mb-8">
    <h1 class="font-mono text-3xl font-semibold text-white mb-4">Get In Touch</h1>
    <p class="text-gray-400 max-w-2xl mx-auto">
      Ready to explore ethical investing? Reach out to discuss how we can align your investments with your values.
    </p>
  </div>

  <div class="grid-2col">
    <!-- Contact Form -->
    <div class="card-ec">
      <div class="card-header-ec">
        <h2 class="card-title-ec">Send a Message</h2>
      </div>

      <!-- HTMX Contact Form with Alpine.js -->
      <form
        id="contact-form"
        hx-post="/api/contact/"
        hx-target="#form-response"
        hx-indicator="#form-loading"
        hx-swap="innerHTML"
        class="form-ec relative"
        x-data="{
                      submitting: false,
                      submissionId: null,
                      handleSubmit() {
                          this.submitting = true;
                      },
                      handleResponse(event) {
                          this.submitting = false;
                          // Fix: Check if event and event.detail exist
                          if (!event || !event.detail || !event.detail.xhr) {
                              console.log('HTMX response received but no event detail available');
                              return;
                          }
                          // Extract submission ID from response if available
                          const response = event.detail.xhr.responseText;
                          try {
                              const data = JSON.parse(response);
                              if (data.submission_id) {
                                  this.submissionId = data.submission_id;
                                  console.log('Form submitted with ID:', this.submissionId);
                                  // Optionally check status after a delay
                                  setTimeout(() => this.checkSubmissionStatus(), 2000);
                              }
                          } catch (e) {
                              // Response might be HTML, not JSON
                              console.log('Response is not JSON:', e);
                          }
                      },
                      async checkSubmissionStatus() {
                          if (!this.submissionId) return;
                          try {
                              const response = await fetch(`/api/submission-status/${this.submissionId}/`);
                              const data = await response.json();
                              console.log('Submission status:', data);
                          } catch (e) {
                              console.log('Could not check submission status:', e);
                          }
                      }
                  }"
        @htmx:before-request="handleSubmit()"
        @htmx:after-request="handleResponse($event)"
      >
        {% csrf_token %}

        <!-- Name Field -->
        <div class="form-group-ec">
          <label for="name" class="form-label-ec">Full Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            class="form-input-ec"
            placeholder="Your full name"
            :disabled="submitting"
            required
          />
        </div>

        <!-- Email Field with inline validation -->
        <div class="form-group-ec">
          <label for="email" class="form-label-ec">Email Address *</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-input-ec"
            placeholder="your@email.com"
            autocomplete="email"
            required
            hx-post="/api/validate-email/"
            hx-trigger="blur changed"
            hx-target="#email-feedback"
            hx-indicator="#email-spinner"
            :disabled="submitting"
            aria-describedby="email-feedback"
            aria-invalid="false"
          />
          <span
            id="email-spinner"
            class="htmx-indicator inline-block ml-2 text-purple-400"
            role="status"
            aria-label="Validating email"
          >
            âŸ³
          </span>
          <div id="email-feedback" class="mt-1 text-sm" role="status" aria-live="polite" aria-atomic="true"></div>
        </div>

        <!-- Company Field -->
        <div class="form-group-ec">
          <label for="company" class="form-label-ec">Company/Organization</label>
          <input
            type="text"
            id="company"
            name="company"
            class="form-input-ec"
            placeholder="Your company or organization"
            :disabled="submitting"
          />
        </div>

        <!-- Subject -->
        <div class="form-group-ec">
          <label for="subject" class="form-label-ec">Subject *</label>
          <select id="subject" name="subject" class="form-select-ec" :disabled="submitting" required>
            <option value="">Select a topic...</option>
            <option value="general">General Inquiry</option>
            <option value="investment_inquiry">Investment Services</option>
            <option value="partnership">Partnership Opportunities</option>
            <option value="adviser_partnership">Adviser Partnership</option>
            <option value="institutional">Institutional Services</option>
            <option value="compliance">Compliance Questions</option>
            <option value="support">Support</option>
          </select>
        </div>

        <!-- Message -->
        <div class="form-group-ec">
          <label for="message" class="form-label-ec">Message *</label>
          <textarea
            id="message"
            name="message"
            class="form-textarea-ec"
            placeholder="Tell us about your investment goals, timeline, or any specific questions you have..."
            :disabled="submitting"
            required
          ></textarea>
        </div>

        <!-- Cloudflare Turnstile -->
        <div class="form-group-ec">
          <div
            class="cf-turnstile"
            data-sitekey="0x4AAAAAABk5jZxSl-TKV1hs"
            data-callback="onTurnstileSuccess"
            data-error-callback="onTurnstileError"
            data-theme="dark"
          ></div>
        </div>

        <!-- Submit Button -->
        <div class="flex gap-4">
          <button type="submit" class="btn-ec-primary" :disabled="submitting" aria-describedby="form-response">
            <span x-show="!submitting">Send Message</span>
            <span x-show="submitting" x-cloak>
              <svg class="animate-spin h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Sending...
            </span>
          </button>
        </div>

        <!-- Loading indicator -->
        <div
          id="form-loading"
          class="htmx-indicator bg-opacity-95 absolute inset-0 flex items-center justify-center rounded-lg bg-gray-900"
          role="status"
          aria-label="Form submission in progress"
        >
          <div class="text-center">
            <svg class="animate-spin h-12 w-12 mx-auto mb-4 text-purple-400" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-purple-200">Submitting your message...</p>
          </div>
        </div>
      </form>

      <!-- Response container -->
      <div
        id="form-response"
        x-ref="formResponse"
        class="mt-4"
        role="status"
        aria-live="polite"
        aria-atomic="true"
      ></div>
    </div>

    <!-- Contact Information -->
    <div class="card-ec">
      <!-- Direct Contact -->
      <div class="mb-6">
        <h3 class="card-title-ec">Direct Contact</h3>
        <div class="space-y-3">
          <div class="flex items-center">
            <span class="w-5 h-5 mr-3 text-purple-400">ðŸ“§</span>
            <div>
              <p class="font-mono text-sm text-gray-300">Email</p>
              <a href="mailto:hello@ethicic.com" class="text-purple-400 hover:text-purple-300 transition-colors">hello@ethicic.com</a>
            </div>
          </div>
          <div class="flex items-center">
            <span class="w-5 h-5 mr-3 text-purple-400">ðŸ“ž</span>
            <div>
              <p class="font-mono text-sm text-gray-300">Phone</p>
              <a href="tel:+13476259000" class="text-purple-400 hover:text-purple-300 transition-colors">(347) 625-9000</a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Office Info -->
      <div>
        <h3 class="card-title-ec">Office Information</h3>
        <div class="text-gray-400 text-sm space-y-2">
          <p><strong class="text-gray-300">Ethical Capital</strong></p>
          <p>Sloane Ortel, Principal</p>
          <p>90 N 400 E<br>Provo, UT 84606</p>
          <p class="text-xs pt-2 border-t border-gray-600">
            Investment Adviser Representative<br />
            CRD #316032
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Cloudflare Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  // Turnstile callback functions
  function onTurnstileSuccess(token) {
    // Store the token in the hidden field
    const hiddenField = document.querySelector('input[name="cf_turnstile_response"]');
    if (hiddenField) {
      hiddenField.value = token;
    }
  }

  function onTurnstileError(error) {
    console.error('Turnstile error:', error);
  }

  // Add custom styles for better form appearance
  const styleSheet = document.createElement("style");
  styleSheet.innerText = `
    .cf-turnstile {
      margin: 1rem 0;
    }
    
    .form-group-ec {
      margin-bottom: 1.5rem;
    }
    
    .htmx-indicator {
      opacity: 0;
    }
    
    .htmx-request .htmx-indicator {
      opacity: 1;
    }
    
    .htmx-request.htmx-indicator {
      opacity: 1;
    }
    
    /* Ensure proper focus styles for accessibility */
    .form-input-ec:focus,
    .form-select-ec:focus,
    .form-textarea-ec:focus {
      outline: 2px solid #a855f7;
      outline-offset: 2px;
    }
  `;
  document.head.appendChild(styleSheet);
</script>
{% endblock %}